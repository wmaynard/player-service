# player-service

An API for managing player inventory and stats.

This is a replacement for the Groovy player-service.  Please read about the important changes to the API in the [upgrade documentation](GROOVY_UPGRADE.md).

# Introduction

This service is the heavyweight and entry point for any game client.  Responsible for account management, player-service handles the important player data.  Something like chat-service can face downtime without much consequence, but if this service is down, the game itself is unplayable.

Consequently, any changes to player-service need to be carefully considered and thoroughly tested, with clear communication among all relevant team members.

# Glossary

| Term            | Definition                                                                                                                                                 |
|:----------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------|
| AccountId / aid | The MongoDB identifier for an account.                                                                                                                     |
| Component       | A collection of related objects for the player.                                                                                                            |
| Discriminator   | A numeric value, 0-9999, appended to a screenname that guarantees a username is unique.                                                                    |
| Link            | Connects one account to another.  When an account is **linked**, it reads and updates the data of a _different_ account rather than its own.               |
| Merge           | Outdated term.  The Groovy version of player-service used this to describe linking a new device SSO login to a previous account. The new term is **Link**. |
| Screenname      | The name a player has chosen.  For new accounts, this is generated by `NameGeneratorService` in an alliterative form of `{adjective} {noun}`.              |
| SSO             | Single Sign-On.  SSO refers to signing in with a third-party identity provider, such as Google Play, Apple ID, or Facebook.                                |
| Username        | A user's full client-facing name, in the form of `Screenname#XXXX`.                                                                                        |

# Class Overview

## Controllers
| Name              | Description                                                             |
|:------------------|:------------------------------------------------------------------------|
| `AdminController` | Handles the operations for administrative tools, such as the CS portal. |
| `TopController`   | Handles client requests to `launch`, `update`, etc.                     |

## Exceptions
| Name                                | Description                                                                                                                                                                                           |
|:------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `DiscriminatorUnavailableException` | Thrown when discriminator generation fails.  This should be a very rare occurrence and should only happen if a large group of people actively creates thousands of accounts with the same screenname. |
| `InvalidUserException`              ||
| `NameGenerationException`           | Thrown when the name generator can't create a name for a user.  Seeing this exception means the `NameGeneratorService` has exhausted its pool of adjectives or nouns and was unable to reload them.   |

## Models
| Name                  | Description                                                                                                                                                                  |
|:----------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `Component`           | A very simple model consisting of an `AccountId` and a `Data` field. Used to store data from the client in an agnostic way, without maintaining specific models.             |
| `DiscriminatorGroup`  | The base model for `DiscriminatorService`.  Each unique discriminator creates a group, and each group can have any number of members, so long as their screenname is unique. |
| `DiscriminatorMember` | Represents a player account within the context of the `DiscriminatorService`.  Tracks the AccountId and Screenname for a user.                                               |
| `Player`              | Represents a player account.  Contains information about the local client installation, data versions, and any relevant transfer tokens.                                     |
| `Profile`             | Represents an SSO account.  Used to identify an account when a client is logging in with external services such as Google Play.                                              |

Notes: 

1. Generally speaking, don't use `Player.Id` when looking for data.  Use `Player.AccountId`.  This is a wrapper that first checks to see if the `Id` has been overridden.
2. While there are profiles for `installIds`, these are possibly unnecessary with the changes to the way accounts are linked to their data.  For more information, see the [upgrade documentation](GROOVY_UPGRADE.md).

### Models.Responses
| Name | Description |
|:-----|:------------|
|      |             |

## Services
| Name                   | Description                                                                                                                                   |
|:-----------------------|:----------------------------------------------------------------------------------------------------------------------------------------------|
| `DiscriminatorService` | Generates **discriminators** for users.  When a username changes, it attempts to use the one previously assigned before generating a new one. |
| `NameGeneratorService` | Generates an alliterative name for new players in the form of `{adjective} {noun}`.                                                           |
| `PlayerAccountService` | Retrieves and updates information for client installations.                                                                                   |
| `ProfileService`       | Retrieves and updates information for SSO logins.                                                                                             |

Notes:

1. The source pool for the `NameGeneratorService` is split between `~/adjectives.txt` and `~/nouns.txt`.  Every word in the pool should be its own line.  Words can be commented out with `//`.

### Services.ComponentServices
| Name                 | Description                                                         |
|:---------------------|:--------------------------------------------------------------------|
| `AbTestService`      |                                                                     |
| `AccountService`     |                                                                     |
| `ComponentService`   | Base class for all component services.                              |
| `EquipmentService`   ||
| `HeroService`        ||
| `MultiplayerService` ||
| `QuestService`       ||
| `StoreService`       ||
| `SummaryService`     | Stores information such as hero score for PvP / social information. |
| `TutorialService`    ||
| `WalletService`      ||
| `WorldService`       ||

### Regarding the efficacy and design of components and items

Will on 2021.12.16:

.NET Platform standards are to have a separate Service for every collection in MongoDB.  Conceptually, this is simple and intuitive.  Unfortunately, the way the groovy solution was architected, data was spread out over nearly a dozen collections.  While we could make an exception and create one Service to handle multiple collections, I'd much rather remain consistent with our current standards.

The original design strikes me as questionable.  I suspect it was coming from someone with an RDBMS background, thinking that this would be more efficient because each collection is like a 
table.  This means that to fully update a player record, we're running a dozen updates instead of just one.  Consequently, there are many more possible points of failure and we're much more likely to require a transactional rollback when updating more than one component at a time.  It's also much more work to maintain.

We aren't really at risk of hitting the maximum document size of 16MB.  I suspect there's an opportunity to both increase performance and reduce complexity by moving everything to something like a `Record` with fields for each component, and only have one per player account.

However, if we are rarely / never updating more than one component at a time, the original design could be more performant.  It's worth an investigation at some point to see if the increase in complexity is worth any performance differences.

Similarly, the `items` collection is iffy.  As designed, every single item is stored as a separate entry in MongoDB.  Each hero, each piece of equipment, each autoplay... all of these are separate entries.  At the time of this writing, there are over 2.3m records in prod.  I've been unable to find a definitive answer, but I suspect there is a point where the number of documents impacts performance.

## Utilities
| Name          | Description                                                                                                                |
|:--------------|:---------------------------------------------------------------------------------------------------------------------------|
| `AppleToken`  | Apple ID requires decrypting a token and validating it via a provided public key.  This utility handles the related logic. |

## Endpoints

### Top level

| Method | Endpoint    | Description                                                                                                                       | Required Fields | Optional Fields |
|-------:|:------------|:----------------------------------------------------------------------------------------------------------------------------------|:----------------|:----------------|
|    GET | `/config`   | Returns dynamic config variables for the client.                                                                                  |||
|    GET | `/health`   | Health check; returns the status of all services.                                                                                 |||
|   POST | `/launch`   | Logs in to the game.  Creates a player record if none exist, then grants an `accessToken` for the account in question.            | `installId`     ||
|  PATCH | `/transfer` | Links an account to one with a corresponding SSO profile, transfers the SSO profile to the local account, or cancels the request. | `transferToken` | `profileIds`    |
|  PATCH | `/update`   | Updates a player record (components, items).                                                                                      | `components`    ||

### Admin

| Method | Endpoint    | Description                                                                                                                       | Required Fields | Optional Fields |
|-------:|:------------|:----------------------------------------------------------------------------------------------------------------------------------|:----------------|:----------------|

## Future Updates, Optimizations, and Nice-to-Haves

* Revisiting the player components and items design is a must.  We should compare the original design and a new design with proper load testing via tools like Locust and see how the performance compares.  If there's a negligible difference, it's probably only worth changing for a future project.  However, there will probably be significant performance changes.